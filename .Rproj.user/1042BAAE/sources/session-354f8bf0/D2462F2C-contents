---
title: "Data_analysis"
author: "Kaylee Fernandez"
date: "2025-06-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(afex)
library(emmeans)
library(kableExtra)
library(dplyr)
library(tidyverse)
library(afex)
library(emmeans)
library(remotes)
library(eegUtils)
```

#F0 136 to 280 ms 
```{r}
# Load data
ERP_F0_long <- readr::read_csv("tidy_data_all_erps/ERP_F0_long.csv")

# Create subject ID 
ERP_F0_long <- ERP_F0_long %>%
  mutate(Subject_ID = paste(Participant_ID, L1_L2, sep = "_"))

# Filter 
f0_136_data <- ERP_F0_long %>%
  filter(time_period == "136_280",
         channel %in% c("F3", "FZ", "FC1", "CZ"))

# Repeated-measures ANOVA
aov_pran_136 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = f0_136_data,
  type = 3
)

# ANOVA summary
summary(aov_pran_136)

# Estimated marginal means
em <- emmeans(aov_pran_136, ~ stress * match * L1_L2)
kable(as.data.frame(em), digits = 2)

knitr::kable(nice(aov_pran_136), caption = "F0 136–280 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)
```

#F0 280-400 ms
```{r}
# Filter
f0_280_data <- ERP_F0_long %>%
  filter(time_period == "280_400",
         channel %in% c("F3", "FZ", "FC1", "CZ"))

# Repeated-measures ANOVA
aov_pran_280 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = f0_280_data,
  type = 3,
  return = "afex_aov"
)

# ANOVA summary
summary(aov_pran_280)

# Estimated marginal means
emmeans(aov_pran_280, ~ stress * match * L1_L2)

knitr::kable(nice(aov_pran_280), caption = "F0 280–400 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)
```

# F0 400 to 600 ms 
```{r}
# Filter
f0_400_data <- ERP_F0_long %>%
  filter(time_period == "400_600",
         channel %in% c("F3", "FZ", "FC1", "CZ")) 

# Repeated-measures ANOVA
aov_pran_400 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = f0_400_data,
  type = 3,
  return = "afex_aov"
)

# ANOVA summary
summary(aov_pran_400)

# Estimated marginal means
emmeans(aov_pran_400, ~ stress * match * L1_L2)

knitr::kable(nice(aov_pran_400), caption = "F0 400–600 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)

```

# Suffix 235 to 415 ms 
```{r}
ERP_suffix_long <- readr::read_csv("tidy_data_all_erps/ERP_suffix_long.csv")

ERP_suffix_long <- ERP_suffix_long %>%
  mutate(Subject_ID = paste(Participant_ID, L1_L2, sep = "_"))

# 235–415 ms
suffix_235_data <- ERP_suffix_long %>%
  filter(time_period == "235_415",
         channel %in% c("F7", "F3", "FC5"))

aov_suffix_235 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = suffix_235_data,
  type = 3,
  return = "afex_aov"
)

# View summary
summary(aov_suffix_235)

# Post-hoc comparisons
emmeans(aov_suffix_235, ~ stress * match * L1_L2)

knitr::kable(nice(aov_suffix_235), caption = "Suffix 235–415 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)
```

# Suffix 415-550 ms
```{r}
suffix_415_data <- ERP_suffix_long %>%
  filter(time_period == "415_550",
         channel %in% c("F7", "F3", "FC5"))

aov_suffix_415 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = suffix_415_data,
  type = 3,
  return = "afex_aov"
)

summary(aov_suffix_415)
emmeans(aov_suffix_415, ~ stress * match * L1_L2)

knitr::kable(nice(aov_suffix_415), caption = "Suffix 415–550 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)
```

# Suffix 550-680 ms 
```{r}
suffix_550_data <- ERP_suffix_long %>%
  filter(time_period == "550_680",
         channel %in% c("F7", "F3", "FC5"))

aov_suffix_550 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = suffix_550_data,
  type = 3,
  return = "afex_aov"
)

summary(aov_suffix_550)
emmeans(aov_suffix_550, ~ stress * match * L1_L2)

knitr::kable(nice(aov_suffix_550), caption = "Suffix 550–680 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)
```

# Suffix 680-800 ms 
```{r}
suffix_680_data <- ERP_suffix_long %>%
  filter(time_period == "680_800",
         channel %in% c("F7", "F3", "FC5"))

aov_suffix_680 <- aov_ez(
  id = "Subject_ID",
  dv = "amplitude",
  within = c("stress", "match"),
  between = "L1_L2",
  data = suffix_680_data,
  type = 3,
  return = "afex_aov"
)

# Summary of ANOVA
summary(aov_suffix_680)

# Estimated marginal means
emmeans(aov_suffix_680, ~ stress * match * L1_L2)

knitr::kable(nice(aov_suffix_680), caption = "Suffix 680–800 ms Repeated Measures ANOVA") %>%
  kable_styling(full_width = FALSE)
```

# Topographic plots
## Topographical maps show the difference in mean ERP amplitude between stressed and unstressed conditions at F0 onset (electrodes: F3, Fz, FC1, Cz) and between mismatch and match conditions at suffix onset (electrodes: F7, F3, FC5) across time windows and groups (L1 vs. L2).Gray regions reflect areas outside the interpolation range based on selected electrodes. 
```{r}

f0_diff <- ERP_F0_long %>%
  filter(channel %in% c("F3", "Fz", "FC1", "Cz"),
         time_period %in% c("136_280", "280_400", "400_600")) %>%
  group_by(channel, L1_L2, stress, time_period) %>%
  summarise(mean_amp = mean(amplitude), .groups = "drop") %>%
  pivot_wider(names_from = stress, values_from = mean_amp) %>%
  mutate(diff = stressed - unstressed)

electrode_coords <- tibble::tribble(
  ~electrode, ~x,   ~y,
  "F3",       -0.4,  0.5,
  "Fz",        0.0,  0.7,
  "FC1",       0.3,  0.4,
  "Cz",        0.0,  0.0
)

f0_diff_coords <- f0_diff %>%
  rename(electrode = channel) %>%
  left_join(electrode_coords, by = "electrode")

ggplot(f0_diff_coords, aes(x = x, y = y, fill = diff, z = diff)) +
  geom_topo(interp_limit = "head", chan_markers = "point", colour = "black") +
  scale_fill_distiller(palette = "RdBu", limits = c(-5, 5)) +
  coord_equal() +
  theme_void() +
  facet_grid(L1_L2 ~ time_period) +
  labs(
    title = "Stressed – Unstressed at F0 Onset",
    fill = expression(Delta~Amplitude~(mu*V))
  )

# Optional: View just L2 values
f0_diff_coords %>%
  filter(L1_L2 == "L2") %>%
  select(electrode, time_period, diff)

# Optional: Confirm counts
ERP_F0_long %>%
  filter(channel %in% c("F3", "Fz", "FC1", "Cz"),
         time_period %in% c("136_280", "280_400", "400_600"),
         L1_L2 == "L2") %>%
  count(channel, time_period)

# ==== SUFFIX ANALYSIS ====
suffix_diff <- ERP_suffix_long %>%
  filter(channel %in% c("F7", "F3", "FC5"),
         time_period %in% c("235_415", "415_550", "550_680", "680_800")) %>%
  group_by(channel, L1_L2, match, time_period) %>%
  summarise(mean_amp = mean(amplitude), .groups = "drop") %>%
  pivot_wider(names_from = match, values_from = mean_amp) %>%
  mutate(diff = mismatch - match)

electrode_coords_suffix <- tibble::tribble(
  ~electrode, ~x,   ~y,
  "F7",       -0.7,  0.3,
  "F3",       -0.4,  0.5,
  "FC5",      -0.5,  0.4
)

suffix_diff_coords <- suffix_diff %>%
  rename(electrode = channel) %>%
  left_join(electrode_coords_suffix, by = "electrode")

ggplot(suffix_diff_coords, aes(x = x, y = y, fill = diff, z = diff)) +
  geom_topo(interp_limit = "head", chan_markers = "point", colour = "black") +
  scale_fill_distiller(palette = "RdBu", limits = c(-5, 5)) +
  coord_equal() +
  theme_void() +
  facet_grid(L1_L2 ~ time_period) +
  labs(
    title = "Mismatch – Match at Suffix Onset",
    fill = expression(Delta~Amplitude~(mu*V))
  )

# Optional: View just L2 values
suffix_diff_coords %>%
  filter(L1_L2 == "L2") %>%
  select(electrode, time_period, diff)

# Optional: Confirm counts
ERP_suffix_long %>%
  filter(channel %in% c("F7", "F3", "FC5"),
         time_period %in% c("235_415", "415_550", "550_680", "680_800"),
         L1_L2 == "L2") %>%
  count(channel, time_period)

```

